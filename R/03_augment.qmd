---
title: "03_augment"
format: html
---

## Load library

```{r}
library("tidyverse")
```

## Load data

```{r}
data_dir <- "data/"
tidy_file <- "02_dat_tidy.tsv.gz"

full_df <- read_tsv("../data/02_dat_tidy.tsv.gz")
glimpse(full_df)
```


## Filtering out extreme AP values
Its noted on the Vanderbilt repo that some entries have extremely high AP values. Unfortunantly the explanation is no longer available. For this reason we choose to remove these rows entirely:
```{r}
full_df |> ggplot(aes(x=serum_prostatic_acid_phosphatase)) +
  geom_histogram(binwidth = 100) +
  labs(
    title = "Distribution of AP values"
  ) +
  best_theme()
```
Based on the plot we discard all entries with AP values above 500
```{r}
full_df <- full_df |> 
  filter(serum_prostatic_acid_phosphatase <= 250)
```



## Augment data

MAP (Mean Arterial Pressure) is the average blood pressure in a personâ€™s arteries during one cardiac cycle (one heartbeat).

```{r}
augment_data<- full_df |>
  mutate(MPA = (sys_blood_pressure+ 2 *dia_blood_pressure) / 3)
glimpse(augment_data)       
```

## Prep data for modellin (notebook 5)

```{r}
full_df |> slice_sample(n = 30) |> print()
```

## Preparing data for modelling

Modelling tumor size vs other factors may pose an interesting investigation and see which factors may be important for tumor development. We need to first conert the columns that are not already numeric to a numeric representation. This can be done in a number of ways but to keep it similar we choose that the higher the number the worse for the potion. Eg normal activity gets low and stuck in bed gets high.

```{r}
df_num <- full_df |>
  mutate(is_alive = case_when(is_alive == "alive" ~ 0,
                              is_alive == "dead" ~ 1),
         performance = case_when(performance == "normal activity" ~ 0,
                                 performance == "in bed < 50% daytime" ~ 1,
                                 performance == "in bed > 50% daytime" ~ 2,
                                 performance == "confined to bed" ~ 4),
         medical_history = as.numeric(medical_history),
         ekg = case_when(ekg == "normal" ~ 0,
                         ekg == "benign" ~ 1,
                         ekg == "heart block or conduction def" ~ 2,
                         ekg == "rhythmic disturb & electrolyte ch" ~ 3,
                         ekg == "old MI" ~ 4,
                         ekg == "recent MI" ~ 5,
                         ekg == "rhythmic disturb & electrolyte ch" ~ 6,
                         ekg == "heart strain" ~ 7),
         bone_metastases = as.numeric(bone_metastases),
         treatment = case_when(treatment == "placebo" ~ 0,
                               treatment == "estrogen" ~ 1)
         )
  
```

Similarly to the example available at https://r4bds.github.io/lab06.html we need a long version of the data where current variable is stored as an entry.

```{r}
df_long <- df_num |>
  select(c(patient_no,stage, age, weight, follow_up_months,
                        sys_blood_pressure, dia_blood_pressure,
                        serum_hemoglobin, serum_prostatic_acid_phosphatase,
                        combined_index, size_of_primary_tumor, is_alive, performance, medical_history,ekg, bone_metastases, treatment, dosage)) |> 
  pivot_longer(cols = c(stage, age, weight, follow_up_months,
                        sys_blood_pressure, dia_blood_pressure,
                        serum_hemoglobin, serum_prostatic_acid_phosphatase,
                        combined_index, is_alive, performance, medical_history,ekg, bone_metastases, treatment, dosage),
               names_to = "variable",
               values_to = "value")
print(df_long |> head(5))
```

```{r}
df_long_nested <- df_long |>
  group_by(variable) |>
  nest()
df_long_nested |> head(10) |> print() #quick check
```

### Save this data
This data is saved as .Rdata to ensure that types are carried over
```{r}
save(df_long_nested, df_num, file = "../data/04_data_for_modelling.Rdata")
```






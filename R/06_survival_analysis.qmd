---
title: "06_survival_analysis"
format: html
editor: visual
---

```{r}
#| message: false
library("tidyverse")
library("survival")
library("broom")
source("99_proj_func.R")
```

## Load dataset

In the previous steps, the original prostate dataset was downloaded and cleaned, seraval other necessary variables were added, and the resulting dataset was saved as 03_dat_aug.tsv.gz. The analysis of that dataset will proceed in this section.

```{r}
#| message: false
full_df <- read_tsv("../data/03_dat_aug.tsv.gz")

# check the data we loaded
full_df |> slice_sample(n = 10)
```

# Baseline comparison between treatment groups

Before conducting survival analyses, it is essential to evaluate whether the treatment groups differ at baseline. The original treatment variable contains four treatment arms ("0.2 mg estrogen", "1.0 mg estrogen", "5.0 mg estrogen", "placebo"). For comparisons, we create a combined variable representing any treatment details then print the table.

```{r}
full_df <- full_df |>
  mutate(
    treatment_detail = factor(treatment_detail, 
                              levels = c("Placebo", 
                                         "0.2mg Estrogen", 
                                         "1.0mg Estrogen", 
                                         "5.0mg Estrogen"))
  )

full_df |> 
  select(treatment_detail) |>
  table()
```

## Summary statistics by treatment group

Here we take a closer look at variables distribution within treatment groups.

```{r}
full_df |>
  group_by(treatment_detail) |>
  summarise(
    n = n(),
    age_mean = mean(age, na.rm = TRUE),
    weight_mean = mean(weight, na.rm = TRUE),
    hemoglobin_mean = mean(serum_hemoglobin, na.rm = TRUE),
    ap_mean = mean(serum_prostatic_acid_phosphatase, na.rm = TRUE),
    tumor_size_mean = mean(size_of_primary_tumor, na.rm = TRUE),
    bm_rate = mean(bone_metastases, na.rm = TRUE),
    medical_history_rate = mean(medical_history, na.rm = TRUE)
    )
```

As we can see there are a few differences within each treatment group to be analysed.

## Hypothesis tests for group differences

To ensure that patients in different treatment groups have similar health condition a statistic was conducted. Continuous variables were compared using ANOVA, and categorical variables using chi-square tests(these functions are from base R).

```{r}
# Age
full_df |>
  oneway.test(age ~ treatment_detail,
              data = _)

# Bone metastasis
chisq.test(table(full_df$bone_metastases, full_df$treatment_detail))

# Serum AP
full_df |>
  oneway.test(serum_prostatic_acid_phosphatase ~ treatment_detail,
              data = _)

# Hemoglobin
full_df |>
  oneway.test(serum_hemoglobin ~ treatment_detail,
              data = _)
```

Significant differences between groups indicate that treatment allocation is not fully randomized with respect to disease burden or patient health status. Such imbalances motivate the need for multivariable survival modeling to adjust for these covariates when estimating treatment effects. All the p-values are above 0.05, which indicates our samples are evenly spread.

## Interpretation

Baseline comparisons help establish whether survival differences are attributed to treatment itself or reflect initial imbalances. For example, higher serum AP or greater frequency of bone metastasis in one group would imply greater disease severity at baseline, which may independently explain poorer outcomes. The results above provide our data is suitable for the survival analyses presented in the following section.

# Survival analysis

To evaluate whether treatment has an effect on time-to-event outcomes, we perform non-parametric survival analysis using Kaplan–Meier estimators and log-rank tests. The dataset provides follow-up time (`follow_up_months`) and a binary mortality indicator (`event`), which allows construction of survival objects. (*Some of the analysis(like cox models) was done by the package survive, in those sections we'll pay more attention to data visualization.)*

## Kaplan–Meier survival curves by treatment group

We begin by constructing a survival object:

```{r}
surv_obj <- Surv(time = full_df$follow_up_months,
                 event = full_df$is_alive)
```

Next, we estimate the Kaplan–Meier curves for the four treatment groups: 0.2 mg estrogen vs 1.0mg estrogen vs 5.0mg estrogen vs placebo. We wrote function km_fit to calculated the survival possibility at each time point and then draw a step plot to the relationship of survival possibility and time.

```{r}
# calculate KM
km_res <- km_fit(
  data = full_df,
  time = "follow_up_months",
  event = "is_alive",
  group = "treatment_detail"
)

# draw survival curve
km_res |>
  ggplot(aes(x = time, y = surv, color = group)) +
  geom_step(size = 1) +
  labs(
    x = "Follow-up months",
    y = "Survival probability",
    title = "Kaplan–Meier Curves"
  ) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5) # keep titles in the middle
  )

save_and_show("surv_curv by treatment")
```

The Kaplan–Meier curves illustrate how survival probabilities decline over time for patients receiving estrogen therapy versus placebo. The 1.0mg Estrogen group have a significantly larger survival probability than the other, which provides a brief insight that this can be considered as a effective treatment.

## Log-rank test

A log-rank test formally assesses whether the survival curves of the two treatment groups differ.

```{r}
logrank_test <- survdiff(surv_obj ~ treatment_detail, data = full_df)
logrank_test
```

The p-value is 0.04 (\< 0.05), which indicates statistically significant differences in survival between the treatment groups. The results from the survival curves is in agreement with this indication.

# Cox proportional hazards modeling

Kaplan–Meier curves provide an unadjusted comparison of survival between the treatment groups, but they do not account for baseline imbalances in disease severity or physiological status. To estimate treatment effects while controlling for potential confounders, a Cox proportional hazards model is applied. Both univariate and multivariable Cox regressions are considered to evaluate the association between clinical variables and mortality risk.

## Univariate Cox models

First fitted are univariate Cox models for key predictors identified in Sections 2 and 3, including tumor burden (AP, tumor size, bone metastases), physiological status (hemoglobin, age, MAP), and clinical stage.

```{r}
cox_vars <- c("treatment_detail",
              "age",
              "serum_hemoglobin",
              "serum_prostatic_acid_phosphatase",
              "size_of_primary_tumor",
              "bone_metastases",
              "stage",
              "MAP",
              "weight")

# merge the results
uni_df <- map_df(cox_vars, function(v) {
  formula <- as.formula(str_c("Surv(follow_up_months, is_alive) ~ ", v))
  model <- coxph(formula, data = full_df)
  tidy(model, exponentiate = TRUE, conf.int = TRUE) |>
    mutate(variable = v)
})

# rename for cleanner look
uni_df <- uni_df |>
  mutate(
    Variable = case_when(
      variable == "treatment_detail" & grepl("0\\.2mg", term) ~ "Estrogen 0.2mg (vs placebo)",
      variable == "treatment_detail" & grepl("1\\.0mg", term) ~ "Estrogen 1.0mg (vs placebo)",
      variable == "treatment_detail" & grepl("5\\.0mg", term) ~ "Estrogen 5.0mg (vs placebo)",
      variable == "stage" & term == "stage4" ~ "Stage IV (vs Stage III)",
      variable == "bone_metastases" ~ "Bone metastasis (yes vs no)",
      variable == "serum_hemoglobin" ~ "Hemoglobin",
      variable == "size_of_primary_tumor" ~ "Tumor size",
      variable == "serum_prostatic_acid_phosphatase" ~ "AP",
      variable == "MAP" ~ "MAP",
      variable == "age" ~ "Age",
      variable == "weight" ~ "Weight",
      TRUE ~ term
    ),
    HR = estimate,
    lower = conf.low,
    upper = conf.high,
    p_sig = p.value < 0.05,
    HR_color = ifelse(HR > 1, "orange", "blue"),
    label_color = ifelse(p_sig, "red", "black"),
    label_face = ifelse(p_sig, "bold", "plain")
  ) |>
  arrange(HR) |>
  mutate(Variable = factor(Variable, levels = Variable))

# draw forestplot
uni_df |>
  ggplot(aes(x = HR, y = Variable)) +
  geom_point(aes(color = HR_color), size = 3) +
  geom_errorbarh(aes(xmin = lower, xmax = upper, color = HR_color), height = 0.25) +
  geom_vline(xintercept = 1, linetype = "dashed") +
  scale_color_identity() +
  scale_x_log10() +
  labs(
    title = "Univariate Cox Model",
    x = "Hazard Ratio (log scale)",
    y = ""
  ) +
  theme_minimal(base_size = 14) +
  theme(
    axis.text.y = element_text(size = 12,
                               color = uni_df$label_color,
                               face = uni_df$label_face)
  )

save_and_show("Univariate_cox_model")
```

In the forest plot, variables are marked with HR \> 1 orange and those with HR \< 1 blue. The variables with significant difference are shown red and emphasis their names. The univariate Cox analyses shows that Age, AP, tumor size, bone metastasis, and clinical stage were all associated with increased hazard of death, consistent with known clinical behavior of advanced prostate cancer. Hemoglobin was protective. Among treatment arms, only 1.0mg estrogen showed a significantly reduced hazard compared with placebo. MAP showed no significant association with survival.

## Multivariable Cox model

Next a multivariable model incorporating treatment group and major clinical covariates is fitted. Predictors were chosen based on biological relevance and the exploratory findings from earlier analysis sections.

```{r}
cox_multi <- coxph(
  Surv(follow_up_months, is_alive) ~
    treatment_detail +
    age +
    serum_hemoglobin +
    serum_prostatic_acid_phosphatase +
    size_of_primary_tumor +
    bone_metastases +
    stage +
    MAP+
    weight,
  data = full_df
  )

# clean the result
multi_df <- tidy(cox_multi, exponentiate = TRUE, conf.int = TRUE) |>
  mutate(
    HR = estimate,
    lower = conf.low,
    upper = conf.high,
    Variable = term,
    p_sig = p.value < 0.05,    # whether it's significant
    HR_color = ifelse(HR > 1, "orange", "blue"),   
    label_color = ifelse(p_sig, "red", "black"),   
    label_face = ifelse(p_sig, "bold", "plain")    
  ) |>
  # rename
  mutate(
    Variable = case_when(
      grepl("0\\.2mg", Variable) ~ "Estrogen 0.2mg (vs placebo)",
      grepl("1\\.0mg", Variable) ~ "Estrogen 1.0mg (vs placebo)",
      grepl("5\\.0mg", Variable) ~ "Estrogen 5.0mg (vs placebo)",
      Variable == "stage4" ~ "Stage IV (vs Stage III)",
      Variable == "bone_metastasesTRUE" ~ "Bone metastasis (yes vs no)",
      Variable == "serum_hemoglobin" ~ "Hemoglobin",
      Variable == "size_of_primary_tumor" ~ "Tumor size",
      Variable == "serum_prostatic_acid_phosphatase" ~ "AP",
      Variable == "MAP" ~ "MAP",
      Variable == "age" ~ "Age",
      Variable == "weight" ~ "Weight",
      TRUE ~ Variable
    )
  ) |>
  arrange(HR) |>                   # order
  mutate(Variable = factor(Variable, levels = Variable))

# draw forestplot
multi_df |>
  ggplot(aes(x = HR, y = Variable)) +
  geom_point(aes(color = HR_color), size = 3) +
  geom_errorbarh(aes(xmin = lower, xmax = upper, color = HR_color),
                 height = 0.25) +
  geom_vline(xintercept = 1, linetype = "dashed") +
  scale_color_identity() +    
  scale_x_log10() +
  labs(
    title = "Multivariable Cox Model",
    x = "Hazard Ratio (log scale)",
    y = ""
  ) +
  theme_minimal(base_size = 14) +
  theme(
    axis.text.y = element_text(size = 12,
                               color = multi_df$label_color,
                               face = multi_df$label_face),
    plot.title = element_text(size = 18, face = "bold"),
    panel.grid.major.y = element_blank()
  )
save_and_show("Multivarible_cox_model")
```

The forest plot is similar to the one shown in the univariate section. Indicative in the forest plot bone metastasis, tumor size, AP, and age were strong and statistically significant risk factors, while hemoglobin and the 1.0mg estrogen treatment remained significant protective factors. MAP had no independent prognostic value. Clinical stage lost significance after adjustment, likely due to the stronger explanatory power of AP and metastatic status. These findings indicate that tumor burden biomarkers are the dominant determinants of survival, and 1.0mg estrogen demonstrated a robust and independent therapeutic benefit.

## Interpretation

The multivariable model allows us to draw refined conclusions about predictors of mortality(Bone metastasis, tumor size, AP, and age).

# Outlier and high-risk patient exploration

Earlier discussion highlighted the presence of extreme values in serum acid phosphatase (AP), a biomarker commonly elevated in advanced or metastatic prostate cancer. In this section, outliers are identified, and their clinical characteristics are examined and evaluated based on their survival patterns. This should reveal clinically meaningful patient subgroups at disproportionately high risk.

## Identifying extreme AP values

This begins by examining the upper tail of the AP distribution(using quantile).

```{r}
quantile(full_df$serum_prostatic_acid_phosphatase, probs = c(0.75, 0.90, 0.95, 0.99), na.rm = TRUE)
```

The 95th percentile threshold provides a definition of unusually high AP. Patients above this cutoff are flagged as having severe biochemical evidence of disease activity.

```{r}
high_ap_threshold <- quantile(full_df$serum_prostatic_acid_phosphatase, 0.95, na.rm = TRUE)
high_ap_df <- full_df |> filter(serum_prostatic_acid_phosphatase >= high_ap_threshold)

high_ap_df |> select(patient_no, serum_prostatic_acid_phosphatase, bone_metastases, stage,
                     size_of_primary_tumor)
```

## AP and bone metastases

Because AP is strongly associated with metastatic spread as shown earlier, we assess how extreme AP values align with bone metastasis status by counting the bone_metastases in high_ap groups and draw a barplot.

```{r}
high_ap_df |>
  ggplot(aes(x = bone_metastases)) +
  geom_bar(fill = "steelblue", alpha = 0.6, width = 0.5, color = "black") +
  geom_text(
    stat = "count",
    aes(label = ..count..),
    vjust = -0.2, # in the middle
    size = 5
  ) + # show counts
  labs(
    x = "Bone metastases",
    y = "Count",
    title = "Frequency of Bone Metastases"
  ) +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5) # keep titles in the middle
  )
```

A large fraction of high-AP patients exhibiting bone metastasis strengthens the interpretation that AP reflects tumor burden and metastatic progression.

## Survival of high-AP vs non-high-AP patients

To quantify risk, patients are stratified into high-risk (AP above the 95th percentile) and others, and compare survival curves (obtained by using the same km_fit function used earlier).

```{r}
full_df <- full_df |>
  mutate(
    ap_risk_group = ifelse(serum_prostatic_acid_phosphatase >= high_ap_threshold, "High AP", "Normal AP"),
    ap_risk_group = factor(ap_risk_group)
    )

km_ap <- km_fit(
  data = full_df,
  time_col = "follow_up_months",
  event_col = "is_alive",
  group_col = "ap_risk_group"
)

# draw surv curve

km_ap |>
  ggplot(aes(x = time, y = surv, color = group)) +
  geom_step(size = 1.2) +
  labs(
    x = "Follow-up time (months)",
    y = "Survival probability",
    title = "Survival of High-AP vs Normal-AP Patients"
  ) +
  scale_color_manual(
    values = c(
      "High AP" = "darkred",
      "Normal AP" = "darkgreen"
    )
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    legend.title = element_blank()
  )
```

Patients with extremely elevated AP typically show sharply reduced survival, highlighting AP as a powerful prognostic biomarker.

## Interpretation

The exploration of outliers reveals distinct, clinically meaningful high-risk subgroups. These findings demonstrate that AP is a strong prognostic indicator and justify its inclusion in multivariable survival modeling as well as in clinical interpretation of treatment outcomes.

# Conclusion

This survival analysis, based on 491 patients, successfully estimated Kaplan–Meier survival curves and fitted both univariate and multivariable Cox proportional hazards models. Kaplan–Meier comparisons demonstrated significant differences in survival probabilities among the placebo, 0.2 mg, 1.0 mg, and 5.0 mg estrogen treatment groups.

In univariate Cox analyses, Age, AP, tumor size, bone metastasis, and clinical stage were strong adverse prognostic factors, whereas hemoglobin was protective. Among the treatment arms, only the 1.0 mg estrogen dose demonstrated a significantly reduced hazard of death relative to placebo. MAP showed no significant association with survival.

In the multivariable Cox model, bone metastasis, tumor size, AP, and age remained independent predictors of increased mortality. Hemoglobin and the 1.0 mg estrogen treatment continued to show significant protective effects. MAP did not demonstrate independent prognostic value, and clinical stage lost significance after adjustment, likely reflecting the dominant explanatory role of tumor burden markers such as AP and metastatic status.

Overall, these results indicate that tumor burden biomarkers are the primary determinants of survival in this cohort, and that 1.0 mg estrogen provides a meaningful and independent therapeutic benefit.

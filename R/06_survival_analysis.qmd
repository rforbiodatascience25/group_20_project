---
title: "06_survival_analysis"
format: html
editor: visual
---

```{r}
library(tidyverse)
library(survival)
library(ggplot2)
library(broom)
source("99_proj_func.R")
```

# 1. Load dataset

In the previous steps, the original prostate dataset was downloaded and cleaned, seraval other necessary variables were added, and the resulting dataset was saved as 03_dat_aug.tsv.gz. Here, we begin the analysis from that dataset.

```{r}
data_dir <- "data/"
tidy_file <- "03_dat_aug.tsv.gz"

full_df <- read_tsv("../data/03_dat_aug.tsv.gz")

glimpse(full_df)
```

## 1.1 Removing ap outlines

The raw dataset contains several implausible AP values (e.g.999), which likely represent data entry codes or errors. As recommended by the data source, we remove observations with AP values exceeding 100 to avoid distortion in downstream modeling and correlation analyses.

```{r}
full_df <- full_df %>%
  filter(ap <= 100)

summary(full_df$ap)
```

# 2.Baseline comparison between treatment groups

Before conducting survival analyses, it is essential to evaluate whether the treatment groups differ at baseline. The original treatment variable contains four treatment arms ("0.2 mg estrogen", "1.0 mg estrogen", "5.0 mg estrogen", "placebo"). For comparisons, we create a combined variable representing any treatment details.

```{r}
full_df <- full_df |>
  mutate(
    treatment_detail = factor(treatment_detail, 
                              levels = c("Placebo", 
                                         "0.2mg Estrogen", 
                                         "1.0mg Estrogen", 
                                         "5.0mg Estrogen"))
  )
table(full_df$treatment_detail)
```

## 2.1 Summary statistics by treatment group

Here we take a closer look at several important variables's statistic results.

```{r}
full_df |>
group_by(treatment_detail) |>
  summarise(
    n = n(),
    age_mean = mean(age, na.rm = TRUE),
    weight_mean = mean(weight, na.rm = TRUE),
    hemoglobin_mean = mean(serum_hemoglobin, na.rm = TRUE),
    ap_mean = mean(ap, na.rm = TRUE),
    tumor_size_mean = mean(size_of_primary_tumor, na.rm = TRUE),
    bm_rate = mean(bone_metastases, na.rm = TRUE),
    medical_history_rate = mean(medical_history, na.rm = TRUE)
    )
```

These variables were selected because they represent important aspects of patient status: physiological measures, tumor burden indicators, and metastasis. These factors are potential confounders of survival and therefore must be examined at baseline.

## 2.2 Hypothesis tests for group differences

To ensure that patients in different treatment groups have similar health condition. We did statistic tests to see if the sample's difference is significant. Continuous variables were compared using ANOVA, and categorical variables using chi-square tests.

```{r}
# Age
oneway.test(age ~ treatment_detail, data = full_df)

# Bone metastasis
chisq.test(table(full_df$bone_metastases, full_df$treatment_detail))

# Serum AP
oneway.test(ap ~ treatment_detail, data = full_df)

# Hemoglobin
oneway.test(serum_hemoglobin ~ treatment_detail, data = full_df)
```

Significant differences between groups indicate that treatment allocation is not fully randomized with respect to disease burden or patient health status. Such imbalances motivate the need for multivariable survival modeling to adjust for these covariates when estimating treatment effects. All the p-values are above 0.05, which indicates our samples are evenly spread.

## 2.3 Interpretation

Baseline comparisons help establish whether survival differences are attributed to treatment itself or reflect initial imbalances. For example, higher serum AP or greater frequency of bone metastasis in one group would imply greater disease severity at baseline, which may independently explain poorer outcomes. The results above provide context for the survival analyses presented in the following section.

# 3.Explore relationships between key clinical variables

The descriptive file 04_describe.qmd examined individual variables such as serum prostatic acid phosphatase (AP) and showed the presence of extreme values. In this section, we extend those findings by evaluating clinically meaningful associations between tumor burden indicators, metastatic status, physiological measurements, and disease progression. These exploratory analyses guide which variables should be prioritized in survival and multivariable Cox modeling.

## 3.1 AP levels by bone metastasis status

Serum AP is commonly elevated in advanced prostate cancer and is often used as a surrogate marker for metastatic activity. We compare AP levels between patients with and without bone metastasis.

```{r}
ggplot(full_df, aes(x = factor(bone_metastases),
                    y = ap)) +
  geom_boxplot() +
  labs(
    x = "Bone metastases (FALSE = no, TRUE = yes)",
    y = "Serum acid phosphatase (AP)",
    title = "AP levels in patients with and without bone metastases"
  )
```

AP levels are expected to be substantially higher in patients with bone metastases, reinforcing AP as a marker of advanced disease. This observation is consistent with the extreme AP values identified earlier in 04_describe.qmd.

## 3.2 Tumor size across clinical stage

We examine whether tumor size increases with clinical stage, as more advanced stages are typically associated with larger or more invasive tumors.

```{r}
ggplot(full_df, aes(x = stage, y = size_of_primary_tumor)) +
geom_boxplot() +
  labs(
    x = "Clinical stage",
    y = "Size of primary tumor",
    title = "Tumor size across clinical stages"
    )
```

A monotonic increase in tumor size across stages suggests that tumor size is a useful measure of disease progression and may influence survival risk.

## 3.3 Correlation among continuous clinical variables

We compute pairwise correlations for quantitative biological and physiological measurements to identify potential collinearity before model building.

```{r}
# Select relevant numeric variables
corr_df <- full_df |>
  select(
    age,
    weight,
    serum_hemoglobin,
    ap,
    size_of_primary_tumor,
    MAP
  )

# Compute raw correlation matrix
corr_mat <- cor(corr_df, use = "pairwise.complete.obs")

# Print raw matrix to console (not emphasized in the report)
# corr_mat
```

### Correlation heatmap

```{r}
library(ggcorrplot)

ggcorrplot(
  corr_mat,
  hc.order = TRUE,          # hierarchical clustering for clearer structure
  type = "lower",           # show only lower triangle
  lab = TRUE,               # display correlation values
  lab_size = 3,
  colors = c("#6D9EC1", "white", "#E46726"),  # blue → white → red
  title = "Correlation matrix of clinical variables",
  ggtheme = theme_minimal()
)
```

This correlation matrix helps to identify redundant predictors. All the relevances is below 0.8, which indicates the selected variables can be seen as independent and used in our survival analysis.

## 3.4 Interpretation

These patterns validate clinically meaningful associations: Blood pressure and hemoglobin levels show expected physiological correlations. These relationships justify including AP, bone metastases, stage, and tumor size as covariates in subsequent survival and Cox proportional hazards models.

# 4.Survival analysis

To evaluate whether treatment has an effect on time-to-event outcomes, we perform non-parametric survival analysis using Kaplan–Meier estimators and log-rank tests. The dataset provides follow-up time (`follow_up_months`) and a binary mortality indicator (`event`), which allows construction of survival objects.

## 4.1 Kaplan–Meier survival curves by treatment group

We begin by constructing a survival object:

```{r}
surv_obj <- Surv(time = full_df$follow_up_months,
                 event = full_df$event)
```

Next, we estimate the Kaplan–Meier curves for the four treatment groups: 0.2 mg estrogen vs 1.0mg estrogen vs 5.0mg estrogen vs placebo.

```{r}
fit_rx <- survfit(surv_obj ~ treatment_detail, data = full_df)

plot(
  fit_rx,
  xlab = "Follow-up time (months)",
  ylab = "Survival probability",
  main = "Survival Curves by Estrogen Dosage",
  col = c("blue", "red","yellow","green"),
  lwd = 2
  )

legend(
  "topright",
  legend = levels(full_df$treatment_detail),
  col = c("blue", "red","yellow","green"),
  lwd = 2
  )


```

The Kaplan–Meier curves illustrate how survival probabilities decline over time for patients receiving estrogen therapy versus placebo. The 1.0mg Estrogen group have a significantly larger survival probability than the other, which provides a brief insight that this can be considered as a effective treatment.

To obtain summary estimates:

```{r}
summary(fit_rx)
```

## 4.2 Log-rank test

A log-rank test formally assesses whether the survival curves of the two treatment groups differ.

```{r}
logrank_test <- survdiff(surv_obj ~ treatment_detail, data = full_df)
logrank_test
```

The p-value is 0.04 (< 0.05), which indicates statistically significant differences in survival between the treatment groups. The direction of effect (better or worse survival under estrogen) can be inferred by comparing the Kaplan–Meier curves or byreviewing hazard ratios in later Cox modeling.

# 5. Cox proportional hazards modeling

Kaplan–Meier curves provide an unadjusted comparison of survival between the treatment groups, but they do not account for baseline imbalances in disease severity or physiological status. To estimate treatment effects while controlling for potential confounders, we apply Cox proportional hazards models. We consider both univariate and multivariable Cox regressions to evaluate the association between clinical variables and mortality risk.

## 5.1 Univariate Cox models

We first fit univariate Cox models for key predictors identified in Sections 2 and 3, including tumor burden (AP, tumor size, bone metastases), physiological status (hemoglobin, age), and clinical stage.

```{r}
cox_vars <- c("treatment_detail",
              "age",
              "serum_hemoglobin",
              "ap",
              "size_of_primary_tumor",
              "bone_metastases",
              "stage")

uni_results <- lapply(cox_vars, function(v) {
  formula <- as.formula(paste0("Surv(follow_up_months, event) ~ ", v))
  model <- coxph(formula, data = full_df)
  tidy(model)
})

names(uni_results) <- cox_vars
uni_results
```

These results report hazard ratios (HR), confidence intervals, and p-values. Predictors with statistically significant are associated with increased mortality risk.

## 5.2 Multivariable Cox model

We next fit a multivariable model incorporating treatment group and major clinical covariates. Predictors were chosen based on biological relevance and the exploratory findings from earlier sections.

```{r}
cox_multi <- coxph(
  Surv(follow_up_months, event) ~
    treatment_detail +
    age +
    serum_hemoglobin +
    ap +
    size_of_primary_tumor +
    bone_metastases +
    stage,
  data = full_df
  )

summary(cox_multi)
```

The multivariable Cox model provides adjusted hazard ratios. Interpretation of the treatment effect in this context accounts for baseline differences in tumor burden (AP, tumor size), metastasis, physiological measurements, and stage.

## 5.3 Interpretation

The multivariable model allows us to draw refined conclusions about predictors of mortality.

# 6. Outlier and high-risk patient exploration

The descriptive analysis in 04_describe.qmd highlighted the presence of extreme values in serum acid phosphatase (AP), a biomarker commonly elevated in advanced or metastatic prostate cancer. In this section, we identify outliers, examine their clinical characteristics, and evaluate their survival patterns. This helps reveal clinically meaningful patient subgroups at disproportionately high risk.

## 6.1 Identifying extreme AP values

We begin by examining the upper tail of the AP distribution.

```{r}
quantile(full_df$ap, probs = c(0.75, 0.90, 0.95, 0.99), na.rm = TRUE)

high_ap_threshold <- quantile(full_df$ap, 0.95, na.rm = TRUE)
high_ap_df <- full_df |> filter(ap >= high_ap_threshold)

nrow(high_ap_df)
high_ap_df |> select(patient_no, ap, bone_metastases, stage, size_of_primary_tumor)
```

The 95th percentile threshold provides a data-driven definition of unusually high AP. Patients above this cutoff are flagged as having severe biochemical evidence of disease activity.

## 6.2 AP and bone metastases

Because AP is strongly associated with metastatic spread, we assess how extreme AP values align with bone metastasis status.

```{r}
table(high_ap_df$bone_metastases)
```

A large fraction of high-AP patients exhibiting bone metastasis strengthens the interpretation that AP reflects tumor burden and metastatic progression.

## 6.3 Survival of high-AP vs non-high-AP patients

To quantify risk, we stratify patients into high-risk (AP above the 95th percentile) and others, and compare survival curves.

```{r}
full_df <- full_df |>
  mutate(
    ap_risk_group = ifelse(ap >= high_ap_threshold, "High AP", "Normal AP"),
    ap_risk_group = factor(ap_risk_group)
    )

fit_ap <- survfit(
  Surv(follow_up_months, event) ~ ap_risk_group, data = full_df
  )

plot(
  fit_ap,
  xlab = "Follow-up time (months)",
  ylab = "Survival probability",
  main = "Survival of High-AP vs Normal-AP Patients",
  col = c("darkred", "darkgreen"),
  lwd = 2
  )

legend(
  "topright",
  legend = levels(full_df$ap_risk_group),
  col = c("darkred", "darkgreen"),
  lwd = 2
  )
```

Patients with extremely elevated AP typically show sharply reduced survival, highlighting AP as a powerful prognostic biomarker.

## 6.4 Interpretation

The exploration of outliers reveals distinct, clinically meaningful high-risk subgroups. These findings demonstrate that AP is a strong prognostic indicator and justify its inclusion in multivariable survival modeling (Section 5) as well as in clinical interpretation of treatment outcomes.

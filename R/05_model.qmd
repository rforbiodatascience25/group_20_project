---
title: "05_model"
format: html
---

```{r}
#| message: false
library("tidyverse")
library("readr")
library("broom")
source("99_proj_func.R") # custom functions and theme
```

## Load data

```{r}
#| message: false
df <- read_tsv("../data/02_dat_tidy.tsv.gz") |> tibble()
```

```{r}
df |> slice_sample(n = 30) |> print()
```

## Preparing data for modelling

Modelling tumor size vs other factors may pose an interesting investigation and see which factors may be important for tumor development. We need to first conert the columns that are not already numeric to a numeric representation (\*\*\*\*or ordered factors possibly?). This can be done in a number of ways but to keep it similar we choose that the higher the number the worse for the potion. Eg normal activity gets low and stuck in bed gets high.

```{r}
df_num <- df |>
  mutate(is_alive = case_when(is_alive == "alive" ~ 0,
                              is_alive == "dead" ~ 1),
         performance = case_when(performance == "normal activity" ~ 0,
                                 performance == "in bed < 50% daytime" ~ 1,
                                 performance == "in bed > 50% daytime" ~ 2,
                                 performance == "confined to bed" ~ 4),
         medical_history = as.numeric(medical_history),
         ekg = case_when(ekg == "normal" ~ 0,
                         ekg == "benign" ~ 1,
                         ekg == "heart block or conduction def" ~ 2,
                         ekg == "rhythmic disturb & electrolyte ch" ~ 3,
                         ekg == "old MI" ~ 4,
                         ekg == "recent MI" ~ 5,
                         ekg == "rhythmic disturb & electrolyte ch" ~ 6,
                         ekg == "heart strain" ~ 7),
         bone_metastases = as.numeric(bone_metastases),
         treatment = case_when(treatment == "placebo" ~ 0,
                               treatment == "estrogen" ~ 1)
         )
  
```

Similarly to the example available at https://r4bds.github.io/lab06.html we need a long version of the data where current variable is stored as an entry.

```{r}
df_long <- df_num |>
  select(c(patient_no,stage, age, weight, follow_up_months,
                        sys_blood_pressure, dia_blood_pressure,
                        serum_hemoglobin, serum_prostatic_acid_phosphatase,
                        combined_index, size_of_primary_tumor, is_alive, performance, medical_history,ekg, bone_metastases, treatment, dosage)) |> 
  pivot_longer(cols = c(stage, age, weight, follow_up_months,
                        sys_blood_pressure, dia_blood_pressure,
                        serum_hemoglobin, serum_prostatic_acid_phosphatase,
                        combined_index, is_alive, performance, medical_history,ekg, bone_metastases, treatment, dosage),
               names_to = "variable",
               values_to = "value")
print(df_long |> head(5))
```

```{r}
df_long_nested <- df_long |>
  group_by(variable) |>
  nest()
df_long_nested |> head(10) |> print() #quick check
```

## Modelling tumor size as a function of other factors

```{r}
df_long_nested_model <- df_long_nested |>
  mutate(model_object = map(data,
                            ~lm(size_of_primary_tumor ~ value,
                                data = .x))) |> 
  mutate(tidy_model = map(model_object, ~tidy(.x,
                                              conf.int = TRUE,
                                              conf.level = 0.95))) |> 
  unnest(cols = tidy_model) |> 
  filter(term == "value") |>  #discard intercept terms
  mutate(p_adjusted = p.adjust(p.value)) |> # correct for multiple testing
  arrange(p_adjusted) #sort pvalues to reveal highest significance

df_long_nested_model |> select(-data, -model_object, -term, -std.error, -statistic) |>  print()
```

### Volcano plot

A volcano plot shows our estimate slope vs the p-value.

```{r}
df_long_nested_model |> 
  ggplot(mapping = aes(x = estimate,
                     y = -log10(p_adjusted),
                     color = factor(p_adjusted < 0.05))) +
  geom_point(alpha = 0.9) +
  geom_hline(yintercept = 0)+
  geom_vline(xintercept = 0)+
  best_theme() +
  theme(legend.position = "none") +
  ggrepel::geom_text_repel(aes(label = case_when(p_adjusted < 0.05 ~ variable,
                                                 TRUE ~ ""))) +
  labs(
    title = "Estimate vs -log10 of adjusted p-value",
    y = "-log10 of p-values adjusted for multiple testing",
    x = "estimate")
```

### Forest plot

The forest plot shows the confidence interval of the modelled slope for all variables

```{r}
forest_plot <- df_long_nested_model |> 
  filter(p_adjusted < 0.05) |> 
  ggplot(mapping = aes(x = estimate,
                       y = fct_reorder(variable, estimate),#sort by the skope 
                       xmin = conf.low,
                       xmax = conf.high)) +
  geom_errorbar(orientation = "y") +
  geom_point() +
  geom_vline(xintercept = 0) +
  theme_minimal(base_size = 12) +
  labs(
    x = "Estimates (95% CIs)",
    y = "Variable",
    title = "Variables with significant impact on tumor size"
  ) +
  best_theme()

  ggsave("../results/figures/forest_plot.svg", forest_plot)
  print(forest_plot) #cursed
```

### Multivariate analysis

Now that we've seen which variables significantly relate to `size_of_primary_tumor` we can do a multivariate model.

```{r}
model_tidy <- lm(size_of_primary_tumor ~ serum_hemoglobin + medical_history + bone_metastases,
                 data = df_num) |> 
  tidy()
print(model_tidy)
```

### Distribution of p-values

```{r}
df_long_nested_model |> select(p.value) |> 
  ggplot() +
  geom_histogram(aes(x = p.value),
                 bins = 5) +
  best_theme()
```

## Logistic regression predicting survivability (bad results, shouldnt be used in analysis)

A binary logistic regression is perfomed on the `is_alive` column. This is of limited biological relevanc but may reveal an interesting insight. interesting cols: select(is_alive, age, weight, size_of_primary_tumor,serum_prostatic_acid_phosphatase, performance)

```{r}
# Turn df is_alive column into numeric variable for modelling:
df_num <- df |> mutate(is_alive = case_when(is_alive == "alive" ~ 1,
                                            is_alive == "dead" ~ 0)) |> 
  select(is_alive, size_of_primary_tumor) |> 
  drop_na()
#Pipe it into the ggplt
df_num |> 
  ggplot(aes(y = is_alive,
             x = size_of_primary_tumor)) +
  geom_point() +
  labs(
    x = "Size of primary tumor",
    y = "Alive at time of study (1: YES, 0: NO)",
    title = "Being alive vs tumor size"
  ) +
  best_theme()
```

As we can see there seems to be a threshold for tumor size vs being alive at the time of study. As you can also hear from the formulation this is not a very interesting relationship but we will continue with the analysis anyway.

### Fitting the logistic regression

```{r}
my_glm_mdl <- glm(formula = is_alive ~ size_of_primary_tumor,
                  family = binomial(link = "logit"),
                  data = df_num)
my_glm_mdl
```

```{r}
df_num |> 
  mutate(my_glm_model = pluck(my_glm_mdl, "fitted.values")) |> 
  ggplot(aes(x = size_of_primary_tumor, y = is_alive)) +
  geom_point(alpha = 0.5,
             size = 3) +
  geom_line(aes(y = my_glm_model)) +
  labs(
    x = "Size of primary tumor",
    y = "Alive at time of study (1: YES, 0: NO)",
    title = "Being alive vs tumor size"
  ) +
  best_theme()
```

## Depature from linear models and treatment correlation: AP factor and treatment effects

```{r}
df_num
```

Reasonably if we look at just treatment data, we can explore their relationship and see if they have any effects beyond linear.

```{r}
AP_TS_log_tidy_model <- lm(
  size_of_primary_tumor ~ 
    log(serum_prostatic_acid_phosphatase) + 
    serum_hemoglobin + 
    dosage + 
    bone_metastases +
    stage,
  data = df_num)

print(AP_TS_log_tidy_model |>
        tidy())
```

Disregarding non-significant values:

```{r}
AP_TS_log_tidy_model <- lm(
  size_of_primary_tumor ~ 
    log(serum_prostatic_acid_phosphatase) +
    bone_metastases,
  data = df_num)

print(AP_TS_log_tidy_model |>
        tidy())
```

### Investigating effects on PAP:

```{r}
AP_es_log_tidy_model <- lm(
  log(serum_prostatic_acid_phosphatase) ~
    serum_hemoglobin + 
    dosage +
    bone_metastases +
    stage,
  data = df_num)

print(AP_es_log_tidy_model |> tidy())
```

Again filtering for non-significant contributors.

```{r}
AP_es_log_tidy_model <- lm(
  log(serum_prostatic_acid_phosphatase) ~
    bone_metastases +
    stage,
  data = df_num)

print(AP_es_log_tidy_model |> tidy())
```

### Plotting residuals

```{r}
resid_df <- bind_rows(
  augment(AP_TS_log_tidy_model) |> mutate(model = "Tumor size ~ log(AP)"),
  augment(AP_es_log_tidy_model) |> mutate(model = "Log(AP) ~ estrogen")
)
```

```{r}
resid_df |>
  ggplot(aes(.fitted, .resid)) +
  geom_point(alpha = 0.8, color = "skyblue") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "salmon") +
  geom_smooth(method = "loess", se = FALSE, color = "pink") +
  facet_wrap(~model, scales = "free") +
  labs(
    title = "Residual fit for model comparison",
    x = "Fitted values",
    y = "Residuals"
  ) +
  best_theme()
```

We can see these models are more promising than the linear fits, we can further see if we can improve these even further.

```{r}
AP_TS_log_tidy_model <- lm(
  size_of_primary_tumor ~ 
    log(serum_prostatic_acid_phosphatase)*dosage +
    log(serum_prostatic_acid_phosphatase)*serum_hemoglobin +
    dosage*serum_hemoglobin +
    bone_metastases,
  data = df_num)

print(AP_TS_log_tidy_model |>
        tidy())
```

```{r}
AP_es_log_tidy_model <- lm(
  log(serum_prostatic_acid_phosphatase) ~
    bone_metastases +
    stage +
    I(dosage^2) +
    I(dosage^2)*serum_hemoglobin,
  data = df_num)

print(AP_es_log_tidy_model |> tidy())
```

```{r}
BM_AP_HB_model <- lm(
  bone_metastases ~
    log(serum_prostatic_acid_phosphatase)*I(dosage**2) +
    log(serum_prostatic_acid_phosphatase)*serum_hemoglobin +
    dosage*serum_hemoglobin,
  data = df_num)

print(BM_AP_HB_model |> tidy())
```

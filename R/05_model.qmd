---
title: "05_model"
format: html
---

```{r}
#| message: false
library("tidyverse")
library("readr")
library("broom")
source("99_proj_func.R") # custom functions and theme
```

## Load data

We load the data that was augmented for modelling:

```{r}
load("../data/04_data_for_modelling.Rdata")
```

# Modelling tumor size as a function of variables

Firstly a preliminary analysis of linear model of variables against tumor size as an indicator of disease progression is done.

```{r}
df_long_nested_model <- df_long_nested |>
  mutate(model_object = map(data,
                            ~lm(size_of_primary_tumor ~ value,
                                data = .x))) |> 
  mutate(tidy_model = map(model_object, ~tidy(.x,
                                              conf.int = TRUE,
                                              conf.level = 0.95))) |> 
  unnest(cols = tidy_model) |> 
  filter(term == "value") |>  #discard intercept terms
  mutate(p_adjusted = p.adjust(p.value)) |> # correct for multiple testing
  arrange(p_adjusted) #sort pvalues to reveal highest significance

df_long_nested_model |> 
  select(-data, -model_object, -term, -std.error, -statistic) |>  
  print()
```

Based on these models it appears that most variables have an independent correlation with tumor size. This will be illustrated below.

## Volcano plot

A volcano plot shows our estimate slope vs the p-value.

```{r}
(df_long_nested_model |> 
  ggplot(mapping = aes(x = estimate,
                     y = -log10(p_adjusted),
                     color = factor(p_adjusted < 0.05))) +
  geom_point(alpha = 0.9) +
  geom_hline(yintercept = 0)+
  geom_vline(xintercept = 0)+
  best_theme() +
  theme(legend.position = "none") +
  ggrepel::geom_text_repel(aes(label = case_when(p_adjusted < 0.05 ~ variable,
                                                 TRUE ~ ""))) +
  labs(
    title = "Estimate vs -log10 of adjusted p-value",
    y = "-log10 of p-values adjusted for multiple testing",
    x = "estimate")

save_and_show("linear_volcano")
```

## Forest plot

The forest plot shows the confidence interval of the modeled slope for all variables

```{r}
(forest_plot <- df_long_nested_model |> 
  filter(p_adjusted < 0.05) |> 
  ggplot(mapping = aes(x = estimate,
                       y = fct_reorder(variable, estimate),#sort by the slope 
                       xmin = conf.low,
                       xmax = conf.high)) +
  geom_errorbar(orientation = "y") +
  geom_point() +
  geom_vline(xintercept = 0) +
  theme_minimal(base_size = 12) +
  labs(
    x = "Estimates (95% CIs)",
    y = "Variable",
    title = "Variables with significant impact on tumor size"
  ) +
  best_theme()
save_and_show("linear_forest_plot")
```

## Residual QQ-plots

Here we seek to validate if the linear models make sense of if there is a depature from expected normality.

```{r}
df_resids <- df_long_nested_model |> 
  mutate(aug = map(model_object, broom::augment)) |> 
  unnest(aug)
```

```{r}
(ggplot(df_resids, aes(sample = .resid)) +
  stat_qq() +
  stat_qq_line() +
  facet_wrap(~ variable, scales = "free") +
  theme_minimal()) |>
save_and_show("linear_qq")
```

Evident from the QQ-plots are a distinct departure from the normal-distribution in tails. This is present in each model and therefore it is likely that tumor size has outliers. This is investigated following by a histogram and QQ-plot.

```{r}
(df |> 
  ggplot() +
  geom_histogram(aes(x = size_of_primary_tumor), 
                 color = "black", alpha = 0.8, fill = "grey") +
  best_theme()) |> 
>>>>>>> 37008f1062125604e66f6b4f79aa092cdb659b67
save_and_show("tumor_histogram")
```

```{r}
(df |>  
  ggplot(aes(sample = size_of_primary_tumor)) +
  stat_qq() +
  stat_qq_line(color = "salmon") +
  best_theme()) |>
save_and_show("tumor_qq")
```

These two plots confirm a definite departure from normality, indicative that log-transformed data would make a better fit.

```{r}
(df |>
>>>>>>> 37008f1062125604e66f6b4f79aa092cdb659b67
  filter(size_of_primary_tumor > 0) |>
  ggplot(aes(sample = log(size_of_primary_tumor))) +
  stat_qq() +
  stat_qq_line(color = "salmon") +
  best_theme()) |> 
save_and_show("log_tumor_qq")
```

Evident from the model is a much closer normal distribution even if an S-shape is present this is likely due to a few outliers, but overall it reveals a logarithmic scale may suit the data better.

# Modelling based on log transformed data

As just confirmed it is to be investigated wether a log-transformation of our data improves correlations. This requires dropping patients with tumor size zero.

```{r}
df_long_log <- df_long_nested |> 
  unnest(cols = c(data)) |>
  filter(size_of_primary_tumor > 0)

df_long_log |> slice_sample(n = 10)
```

*Nesting the model objects for cleanliness.*

```{r}
df_long_log_nest <- df_long_log |>
  group_by(variable) |>
  nest()
```

## Model of logarithmic tumor size:

```{r}
df_long_nested_model_log <- df_long_log_nest |>
  mutate(model_object = map(data,
                            ~lm(log(size_of_primary_tumor) ~ value,
                                data = .x))) |> 
  mutate(tidy_model = map(model_object, ~tidy(.x,
                                              conf.int = TRUE,
                                              conf.level = 0.95))) |> 
  unnest(cols = tidy_model) |> 
  filter(term == "value") |>  #discard intercept terms
  mutate(p_adjusted = p.adjust(p.value)) |> # correct for multiple testing
  arrange(p_adjusted) #sort pvalues to reveal highest significance

df_long_nested_model_log |> 
  select(-data, -model_object, -term, -std.error, -statistic) |>  
  print()
```

If we compare these p-values with earlier linear model we see a much more significant correlation between these and log-transformed tumor size. This will be validated with residual QQ-plots.

## Preparing for residual plots

```{r}
df_resids_log <- df_long_nested_model_log |> 
  mutate(aug = map(model_object, 
                   broom::augment)) |> 
  unnest(aug)
```

```{r}
(ggplot(df_resids_log, aes(sample = .resid)) +
  stat_qq() +
  stat_qq_line() +
  facet_wrap(~ variable, scales = "free") +
  theme_minimal()) |> 
save_and_show("log_qq")
```

Aligning with our log-transformed tumor data the variables now also show a smaller from expected expectation normality.

## Volcano plot

A volcano plot shows our estimate slope vs the p-value.

```{r}
(
df_long_nested_model_log |> 
  ggplot(mapping = aes(x = estimate,
                     y = -log10(p_adjusted),
                     color = factor(p_adjusted < 0.05))) +
  geom_point(alpha = 0.9) +
  geom_hline(yintercept = 0)+
  geom_vline(xintercept = 0)+
  best_theme() +
  theme(legend.position = "none") +
  ggrepel::geom_text_repel(aes(label = case_when(p_adjusted < 0.05 ~ variable,
                                                 TRUE ~ ""))) +
  labs(
    title = "Estimate vs -log10 of adjusted p-value",
    y = "-log10 of p-values adjusted for multiple testing",
    x = "estimate")) |> 
save_and_show(plot_name = "log_volcano")
```

## Forest plot

The forest plot shows the confidence interval of the modelled slope for all variables

```{r}
(df_long_nested_model_log |> 
  filter(p_adjusted < 0.05) |> 
  ggplot(mapping = aes(x = estimate,
                       y = fct_reorder(variable, estimate),#sort byr the skope
                       xmin = conf.low,
                       xmax = conf.high)) +
  geom_errorbar(orientation = "y") +
  geom_point() +
  geom_vline(xintercept = 0) +
  theme_minimal(base_size = 12) +
  labs(
    x = "Estimates (95% CIs)",
    y = "Variable",
    title = "Variables with significant impact on tumor size"
  ) +
  best_theme()) |> 
save_and_show("log_forest")
>>>>>>> 37008f1062125604e66f6b4f79aa092cdb659b67
```

# Correlation among continuous clinical variables

Beyond comparison with tumor size a pairwise correlation for the quantitative biological and physiological measurements is computed to identify potential collinearity before survival analysis.

```{r}
# Select relevant numeric variables
corr_df <- df_num |>
  select(
    age,
    weight,
    serum_hemoglobin,
    serum_prostatic_acid_phosphatase,
    size_of_primary_tumor,
    bone_metastases)

# Compute raw correlation matrix
corr_mat <- cor(corr_df, use = "pairwise.complete.obs")
```

### Correlation heatmap

```{r}
# Convert matrix to long format for ggplot2
corr_long <- as.data.frame(corr_mat) |>
  rownames_to_column("Var1") |>
  pivot_longer(
    cols = -Var1,
    names_to = "Var2",
    values_to = "cor"
  )

ggplot(corr_long, aes(x = Var2, y = Var1, fill = cor)) +
  geom_tile(color = "white") +
  geom_text(aes(label = sprintf("%.2f", cor)), size = 3) +
  scale_fill_gradient2(
    low = "blue",
    mid = "white",
    high = "red",
    midpoint = 0,
    limits = c(-1, 1),
    name = "Correlation"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1), # retate words
    panel.grid = element_blank() # remove grid lines
  ) +
  labs(
    title = "Correlation Matrix of Selected Variables",
    x = NULL,
    y = NULL
  )

```

This correlation matrix helps to identify redundant predictors. All the relevances is below 0.8, which indicates the selected variables can be seen as independent and used in a survival analysis. Given previous analysis it can also be concluded that shown variables

# Exploratory multivariate analysis

Expanding on colliniarity and variables that have been shown significant in relation to log(`size_of_primary_tumor`) a few multivariate models are explored.

```{r}
model_tidy <- lm(log(size_of_primary_tumor) ~ 
                   serum_hemoglobin + 
                   medical_history + 
                   bone_metastases + 
                   serum_prostatic_acid_phosphatase,
                 data = df_num |>
                   filter(size_of_primary_tumor > 0)) |> 
  tidy()
print(model_tidy)
```

## Logistic regression predicting survivability (bad results)

A binary logistic regression is perfomed on the `is_alive` column. This is of limited biological relevanc but may reveal an interesting insight. interesting cols: select(is_alive, age, weight, size_of_primary_tumor,serum_prostatic_acid_phosphatase, performance)

```{r}
# Turn df is_alive column into numeric variable for modelling:
df_a_ts <- df_num |>
  select(is_alive, size_of_primary_tumor) |> 
  drop_na()


df_a_ts |>
  ggplot(aes(y = is_alive,
             x = size_of_primary_tumor)) +
  geom_point() +
  labs(
    x = "Size of primary tumor",
    y = "Alive at time of study (1: YES, 0: NO)",
    title = "Being alive vs tumor size"
  ) +
  best_theme()
```

There seems to be a threshold for tumor size vs being alive at the time of study.

### Fitting the logistic regression

```{r}
my_glm_mdl <- glm(formula = is_alive ~ size_of_primary_tumor,
                  family = binomial(link = "logit"),
                  data = df_num)
my_glm_mdl
```

```{r}
df_a_ts |> 
  mutate(my_glm_model = pluck(my_glm_mdl, "fitted.values")) |> 
  ggplot(aes(x = size_of_primary_tumor, y = is_alive)) +
  geom_point(alpha = 0.5,
             size = 3) +
  geom_line(aes(y = my_glm_model)) +
  labs(
    x = "Size of primary tumor",
    y = "Alive at time of study (0: YES, 1: NO)",
    title = "Being alive vs tumor size"
  ) +
  best_theme()
```

As mentioned there seems to be a certain correlation between these two but it is not a very telling analysis so it should not be considered.

## Multivariate on measurements â€“ No significant conclusions

Mentioned preivously this is an exploration of blood and treatment data to evaluate whether it could have an explanatory effect. This is conducted due to QQ-plots showing some variation and S-tailing. First explored is the tumor size, and potential effects of treatment, AP and hemoglobin.

```{r}
ap_ts_log_tidy_model <- lm(
  log(size_of_primary_tumor) ~ 
    log(serum_prostatic_acid_phosphatase) +
    serum_prostatic_acid_phosphatase +
    serum_hemoglobin + 
    dosage + 
    bone_metastases +
    stage,
  data = df_num |> 
    filter(size_of_primary_tumor > 0))

print(ap_ts_log_tidy_model |>
        tidy())
```

Disregarding non-significant values:

```{r}
ap_ts_log_tidy_model |> 
  tidy() |>
  mutate(padj = p.adjust(p.value, method = "fdr")) |>
  filter(padj < 0.05) |>
  save_and_show_table("log_tumor_sig_fit")
```

Seems that log(AP) does have a significant correlation with tumor size but not more than the log tumor size.

## Exploratory analysis of effects on prostatic acid phosphatase

```{r}
ap_es_log_tidy_model <- lm(
  serum_prostatic_acid_phosphatase ~ 
    dosage +
    I(dosage^2) +
    I(dosage^2)*serum_hemoglobin +
    bone_metastases +
    log(size_of_primary_tumor),
  data = df_num |> filter(size_of_primary_tumor > 0))

print(ap_es_log_tidy_model |> tidy())
```

Again filtering for non-significant contributors.

```{r}
ap_es_log_tidy_model |> 
  tidy() |>
  mutate(padj = p.adjust(p.value, method = "fdr")) |>
  filter(padj < 0.05) |>
  print()
```

We see the primary contributors to the AP levels to be bone metastasis, a relevant conclusion as this is prevalent in advanced diagnosis.

## Exploratory analysis of effects on bone metastasis

We wanted to investigate the correlation between bone metastatis and blood factors.

```{r}
bm_ap_hb_model <- lm(
  bone_metastases ~
    serum_prostatic_acid_phosphatase*I(dosage**2) +
    serum_prostatic_acid_phosphatase*serum_hemoglobin +
    dosage*serum_hemoglobin,
  data = df_num)

print(bm_ap_hb_model |> tidy())
```

```{r}
bm_ap_hb_model |> 
  tidy() |>
  mutate(padj = p.adjust(p.value, method = "fdr")) |>
  filter(padj < 0.05) |>
  save_and_show_table("bone_sig_fit")
```

Here we can confirm that bone metastasis is indeed influenced by both AP and hemoglobin levels but not estrogen treatment dosage.

# AP levels by bone metastasis status

As just shown serum AP is commonly elevated in advanced prostate cancer and is often used as a surrogate marker for metastatic activity. We compare AP levels between patients with and without bone metastasis and draw a boxplot to show the result.

```{r}

df_num |>
  ggplot(aes(
    x = factor(bone_metastases), 
    y = serum_prostatic_acid_phosphatase)) +
  geom_boxplot() +
  scale_y_log10() + # for log scale
  labs(
    x = "Bone metastases",
    y = "AP (log scale)",
    title = "AP levels (log scale) by bone metastases status"
  )+
  theme(plot.title = element_text(hjust = 0.5) # keep titles in the middle
  )
```

We can see that AP levels are expected to be substantially higher in patients with bone metastases, reinforcing AP as a marker of advanced disease. This observation is consistent with the extreme AP values identified earlier in 04_describe.

# Interpretation

In summary of this section variables have been confirmed significant to tumor size and by extention disease severity. On top of this conformation of correlation between variables have been confirmed to be used in a survival analysis.

Blood factors have also been confirmed to be correlated with bone metastasis as to be expected but not with eachother.

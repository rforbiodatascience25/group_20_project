---
title: "05_model"
format: html
---

```{r}
#| message: false
library("tidyverse")
library("readr")
library("broom")
source("99_proj_func.R") # custom functions and theme
```

## Load data
We load the data that was prepared for modelling:
```{r}
load("../data/04_data_for_modelling.Rdata")
```

## Modelling tumor size as a function of other factors
```{r}
df_long_nested_model <- df_long_nested |>
  mutate(model_object = map(data,
                            ~lm(size_of_primary_tumor ~ value,
                                data = .x))) |> 
  mutate(tidy_model = map(model_object, ~tidy(.x,
                                              conf.int = TRUE,
                                              conf.level = 0.95))) |> 
  unnest(cols = tidy_model) |> 
  filter(term == "value") |>  #discard intercept terms
  mutate(p_adjusted = p.adjust(p.value)) |> # correct for multiple testing
  arrange(p_adjusted) #sort pvalues to reveal highest significance

df_long_nested_model |> select(-data, -model_object, -term, -std.error, -statistic) |>  print()
```

We can see based on the linear modeling against tumor size, some expected factors rise to the top while the measurable indicators seem to fall short.

### Volcano plot

A volcano plot shows our estimate slope vs the p-value.

```{r}
df_long_nested_model |> 
  ggplot(mapping = aes(x = estimate,
                     y = -log10(p_adjusted),
                     color = factor(p_adjusted < 0.05))) +
  geom_point(alpha = 0.9) +
  geom_hline(yintercept = 0)+
  geom_vline(xintercept = 0)+
  best_theme() +
  theme(legend.position = "none") +
  ggrepel::geom_text_repel(aes(label = case_when(p_adjusted < 0.05 ~ variable,
                                                 TRUE ~ ""))) +
  labs(
    title = "Estimate vs -log10 of adjusted p-value",
    y = "-log10 of p-values adjusted for multiple testing",
    x = "estimate")
```

### Forest plot

The forest plot shows the confidence interval of the modeled slope for all variables

```{r}
forest_plot <- df_long_nested_model |> 
  filter(p_adjusted < 0.05) |> 
  ggplot(mapping = aes(x = estimate,
                       y = fct_reorder(variable, estimate),#sort by the slope 
                       xmin = conf.low,
                       xmax = conf.high)) +
  geom_errorbar(orientation = "y") +
  geom_point() +
  geom_vline(xintercept = 0) +
  theme_minimal(base_size = 12) +
  labs(
    x = "Estimates (95% CIs)",
    y = "Variable",
    title = "Variables with significant impact on tumor size"
  ) +
  best_theme()
save_and_show("forest_plot")
```

### Residual plot

```{r}
df_resids <- df_long_nested_model |> 
  mutate(aug = map(model_object, broom::augment)) |> 
  unnest(aug)
```

```{r}
ggplot(df_resids, aes(sample = .resid)) +
  stat_qq() +
  stat_qq_line() +
  facet_wrap(~ variable, scales = "free") +
  theme_minimal()
```

We see a distinct departure from the normal-distribution in our tails, we can investigate this further by looking at a size histogram and qq-plot.

```{r}
df |> 
  ggplot() +
  geom_histogram(aes(x = size_of_primary_tumor), 
                 color = "black", alpha = 0.8, fill = "grey") +
  best_theme()
```

```{r}
df |>  
  ggplot(aes(sample = size_of_primary_tumor)) +
  stat_qq() +
  stat_qq_line(color = "salmon") +
  best_theme()
```

We can see a definte depature from normality, we can investigate this by doing a log-transformation of our plot.

```{r}
df |>
  filter(size_of_primary_tumor > 0) |>
  ggplot(aes(sample = log(size_of_primary_tumor))) +
  stat_qq() +
  stat_qq_line(color = "salmon") +
  best_theme()
```

As we see this is a much cleaner as has a much smaller depature from the normality assumption.

### Modelling based on log transformed data

Log-transformation requires dropping patients with tumor size zero.

```{r}
df_long_log <- df_long |> 
  filter(size_of_primary_tumor > 0)
```

Nesting the model objects for cleanliness.

```{r}
df_long_log_nest <- df_long_log |>
  group_by(variable) |>
  nest()
```

Model of logarithmic tumor size:

```{r}
df_long_nested_model_log <- df_long_log_nest |>
  mutate(model_object = map(data,
                            ~lm(log(size_of_primary_tumor) ~ value,
                                data = .x))) |> 
  mutate(tidy_model = map(model_object, ~tidy(.x,
                                              conf.int = TRUE,
                                              conf.level = 0.95))) |> 
  unnest(cols = tidy_model) |> 
  filter(term == "value") |>  #discard intercept terms
  mutate(p_adjusted = p.adjust(p.value)) |> # correct for multiple testing
  arrange(p_adjusted) #sort pvalues to reveal highest significance

df_long_nested_model_log |> select(-data, -model_object, -term, -std.error, -statistic) |>  print()
```

#### Preparing for residual plots

```{r}
df_resids_log <- df_long_nested_model_log |> 
  mutate(aug = map(model_object, 
                   broom::augment)) |> 
  unnest(aug)
```

```{r}
ggplot(df_resids_log, aes(sample = .resid)) +
  stat_qq() +
  stat_qq_line() +
  facet_wrap(~ variable, scales = "free") +
  theme_minimal()
```

We can see here and based on the p-values in the table and the subsequent qq-plots have a much smaller departure from normality.

### Volcano plot

A volcano plot shows our estimate slope vs the p-value.

```{r}
df_long_nested_model_log |> 
  ggplot(mapping = aes(x = estimate,
                     y = -log10(p_adjusted),
                     color = factor(p_adjusted < 0.05))) +
  geom_point(alpha = 0.9) +
  geom_hline(yintercept = 0)+
  geom_vline(xintercept = 0)+
  best_theme() +
  theme(legend.position = "none") +
  ggrepel::geom_text_repel(aes(label = case_when(p_adjusted < 0.05 ~ variable,
                                                 TRUE ~ ""))) +
  labs(
    title = "Estimate vs -log10 of adjusted p-value",
    y = "-log10 of p-values adjusted for multiple testing",
    x = "estimate")
```

### Forest plot

The forest plot shows the confidence interval of the modelled slope for all variables

```{r}
df_long_nested_model_log |> 
  filter(p_adjusted < 0.05) |> 
  ggplot(mapping = aes(x = estimate,
                       y = fct_reorder(variable, estimate),#sort byr the skope
                       xmin = conf.low,
                       xmax = conf.high)) +
  geom_errorbar(orientation = "y") +
  geom_point() +
  geom_vline(xintercept = 0) +
  theme_minimal(base_size = 12) +
  labs(
    x = "Estimates (95% CIs)",
    y = "Variable",
    title = "Variables with significant impact on tumor size"
  ) +
  best_theme()
```

### Multivariate analysis

Now that we've seen which variables significantly relate to `size_of_primary_tumor` we can do a multivariate model.

```{r}
model_tidy <- lm(log(size_of_primary_tumor) ~ 
                   serum_hemoglobin + 
                   medical_history + 
                   bone_metastases + 
                   serum_prostatic_acid_phosphatase,
                 data = df_num |>
                   filter(size_of_primary_tumor > 0)) |> 
  tidy()
print(model_tidy)
```

### Distribution of p-values

```{r}
df_long_nested_model |> select(p.value) |> 
  ggplot() +
  geom_histogram(aes(x = p.value), 
                 alpha = 0.8, 
                 color = "black", 
                 fill = "grey",
                 bins = 5) +
  best_theme()
```

## Logistic regression predicting survivability (bad results, shouldnt be used in analysis)

A binary logistic regression is perfomed on the `is_alive` column. This is of limited biological relevanc but may reveal an interesting insight. interesting cols: select(is_alive, age, weight, size_of_primary_tumor,serum_prostatic_acid_phosphatase, performance)

```{r}
# Turn df is_alive column into numeric variable for modelling:
df_a_ts <- df |> mutate(is_alive = case_when(is_alive == "alive" ~ 0,
                                            is_alive == "dead" ~ 1)) |> 
  select(is_alive, size_of_primary_tumor) |> 
  drop_na()


df_a_ts |>
  ggplot(aes(y = is_alive,
             x = size_of_primary_tumor)) +
  geom_point() +
  labs(
    x = "Size of primary tumor",
    y = "Alive at time of study (1: YES, 0: NO)",
    title = "Being alive vs tumor size"
  ) +
  best_theme()
```

As we can see there seems to be a threshold for tumor size vs being alive at the time of study. As you can also hear from the formulation this is not a very interesting relationship but we will continue with the analysis anyway.

### Fitting the logistic regression

```{r}
my_glm_mdl <- glm(formula = is_alive ~ size_of_primary_tumor,
                  family = binomial(link = "logit"),
                  data = df_num)
my_glm_mdl
```

```{r}
df_a_ts |> 
  mutate(my_glm_model = pluck(my_glm_mdl, "fitted.values")) |> 
  ggplot(aes(x = size_of_primary_tumor, y = is_alive)) +
  geom_point(alpha = 0.5,
             size = 3) +
  geom_line(aes(y = my_glm_model)) +
  labs(
    x = "Size of primary tumor",
    y = "Alive at time of study (0: YES, 1: NO)",
    title = "Being alive vs tumor size"
  ) +
  best_theme()
```

### Multivariate on measurements

We wanted to explore if some of the blood and treatment data could have an explanatory effect on some of our variables. First explored is the tumor size, and potential effects of treatment, AP and hemoglobin.

```{r}
ap_ts_log_tidy_model <- lm(
  log(size_of_primary_tumor) ~ 
    log(serum_prostatic_acid_phosphatase) +
    serum_prostatic_acid_phosphatase +
    serum_hemoglobin + 
    dosage + 
    bone_metastases +
    stage,
  data = df_num |> 
    filter(size_of_primary_tumor > 0))

print(ap_ts_log_tidy_model |>
        tidy())
```

Disregarding non-significant values:

```{r}
ap_ts_log_tidy_model |> 
  tidy() |>
  mutate(padj = p.adjust(p.value, method = "fdr")) |>
  filter(padj < 0.05) |>
  print()
```

Seems that log(AP) does have a significant correlation with tumor size.

### Exploratory analysis of effects on prostatic acid phosphatase:

```{r}
ap_es_log_tidy_model <- lm(
  log(serum_prostatic_acid_phosphatase) ~ 
    dosage +
    I(dosage^2) +
    I(dosage^2)*serum_hemoglobin +
    bone_metastases +
    log(size_of_primary_tumor),
  data = df_num |> filter(size_of_primary_tumor > 0))

print(ap_es_log_tidy_model |> tidy())
```

Again filtering for non-significant contributors.

```{r}
ap_es_log_tidy_model |> 
  tidy() |>
  mutate(padj = p.adjust(p.value, method = "fdr")) |>
  filter(padj < 0.05) |>
  print()
```

We see the primary contributors to the AP levels to be tumor size and metastasis stage.

### Exploratory multi-variable analysis of parameters with combination -- No significant results

Beyond this, an investigation into variable combination was done.

```{r}
ap_ts_log_tidy_model <- lm(
  log(size_of_primary_tumor) ~ 
    log(serum_prostatic_acid_phosphatase)*dosage +
    log(serum_prostatic_acid_phosphatase)*serum_hemoglobin +
    dosage*serum_hemoglobin,
  data = df_num |> filter(size_of_primary_tumor > 0))

print(ap_ts_log_tidy_model |>
        tidy())
```

```{r}
ap_ts_log_tidy_model |> 
  tidy() |>
  mutate(padj = p.adjust(p.value, method = "fdr")) |>
  filter(padj < 0.05) |>
  print()
```

Resulting in no significant correlations, even if it was expected that estrogen dosage has an effect on tumor growth.

### Bone metastasis

We wanted to investigate the correlation between bone metastatis and blood factors.

```{r}
bm_ap_hb_model <- lm(
  bone_metastases ~
    log(serum_prostatic_acid_phosphatase)*I(dosage**2) +
    log(serum_prostatic_acid_phosphatase)*serum_hemoglobin +
    dosage*serum_hemoglobin,
  data = df_num)

print(bm_ap_hb_model |> tidy())
```

```{r}
bm_ap_hb_model |> 
  tidy() |>
  mutate(padj = p.adjust(p.value, method = "fdr")) |>
  filter(padj < 0.05) |>
  print()
```

Here we can confirm that bone metastasis is indeed influenced by both AP and hemoglobin levels but not estrogen treatment dosage.
